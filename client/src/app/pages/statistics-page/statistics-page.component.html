<app-ui-page-layout [hasHeader]="true" [showBackButton]="true" headerTitle="End Game Statistics" (backClick)="onBackClick()">
    <div class="statistics-grid">
        <!-- Global statistics zone - 1/3 height, full width -->
        <section class="global-statistics">
            <h2>Global Statistics</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Game Duration</span>
                    <span class="stat-value">{{ globalStatistics().gameDuration }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Turns</span>
                    <span class="stat-value">{{ globalStatistics().totalTurns }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Tiles Visited</span>
                    <span class="stat-value">{{ globalStatistics().tilesVisitedPercentage }}%</span>
                </div>
                @if (globalStatistics().totalTeleportations !== undefined) {
                <div class="stat-item">
                    <span class="stat-label">Total Teleportations</span>
                    <span class="stat-value">{{ globalStatistics().totalTeleportations }}</span>
                </div>
                } @if (globalStatistics().doorsManipulatedPercentage !== undefined) {
                <div class="stat-item">
                    <span class="stat-label">Doors Manipulated</span>
                    <span class="stat-value">{{ globalStatistics().doorsManipulatedPercentage }}%</span>
                </div>
                } @if (globalStatistics().sanctuariesUsedPercentage !== undefined) {
                <div class="stat-item">
                    <span class="stat-label">Sanctuaries Used</span>
                    <span class="stat-value">{{ globalStatistics().sanctuariesUsedPercentage }}%</span>
                </div>
                } @if (globalStatistics().flagHoldersCount !== undefined) {
                <div class="stat-item">
                    <span class="stat-label">Players Who Held the Flag</span>
                    <span class="stat-value">{{ globalStatistics().flagHoldersCount }}</span>
                </div>
                }
            </div>
        </section>

        <!-- Players table - 2/3 height, 2/3 width -->
        <section class="players-table-section">
            <h2>Player Statistics</h2>
            <div class="table-container">
                <table class="players-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th
                                class="sortable"
                                (click)="sortBy('combatCount')"
                                [class.active]="isSortActive('combatCount')"
                                [attr.data-sort]="getSortIcon('combatCount')"
                            >
                                <div class="header-content">
                                    <span class="header-text">Combats</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th
                                class="sortable"
                                (click)="sortBy('combatWins')"
                                [class.active]="isSortActive('combatWins')"
                                [attr.data-sort]="getSortIcon('combatWins')"
                            >
                                <div class="header-content">
                                    <span class="header-text">Wins</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th
                                class="sortable"
                                (click)="sortBy('combatLosses')"
                                [class.active]="isSortActive('combatLosses')"
                                [attr.data-sort]="getSortIcon('combatLosses')"
                            >
                                <div class="header-content">
                                    <span class="header-text">Losses</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th
                                class="sortable"
                                (click)="sortBy('healthLost')"
                                [class.active]="isSortActive('healthLost')"
                                [attr.data-sort]="getSortIcon('healthLost')"
                            >
                                <div class="header-content">
                                    <span class="header-text">HP Lost</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th
                                class="sortable"
                                (click)="sortBy('healthDealt')"
                                [class.active]="isSortActive('healthDealt')"
                                [attr.data-sort]="getSortIcon('healthDealt')"
                            >
                                <div class="header-content">
                                    <span class="header-text">HP Dealt</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th
                                class="sortable"
                                (click)="sortBy('tilesVisitedPercentage')"
                                [class.active]="isSortActive('tilesVisitedPercentage')"
                                [attr.data-sort]="getSortIcon('tilesVisitedPercentage')"
                            >
                                <div class="header-content">
                                    <span class="header-text">Tiles Visited (%)</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (player of playersStatistics(); track player.name) {
                        <tr>
                            <td class="player-name">{{ player.name }}</td>
                            <td class="stat-number">{{ player.combatCount }}</td>
                            <td class="stat-number wins">{{ player.combatWins }}</td>
                            <td class="stat-number losses">{{ player.combatLosses }}</td>
                            <td class="stat-number">{{ player.healthLost }}</td>
                            <td class="stat-number">{{ player.healthDealt }}</td>
                            <td class="stat-number">{{ player.tilesVisitedPercentage }}%</td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Messages zone - 2/3 height, 1/3 width -->
        <aside class="messages-section">
            <div class="messages-header">
                <h2>Messages</h2>
                <div class="header-controls">
                    <div class="tabs">
                        <button class="tab" [class.active]="isActiveTab('chat')" (click)="setActiveTab('chat')">Chat</button>
                        <button class="tab" [class.active]="isActiveTab('journal')" (click)="setActiveTab('journal')">Log</button>
                    </div>
                    @if (isActiveTab('journal')) {
                    <label class="filter-checkbox">
                        <input type="checkbox" [checked]="!gameLogService.filterByMe()" (change)="gameLogService.toggleFilter()" />
                        <span>All</span>
                    </label>
                    }
                </div>
            </div>
            <div class="messages-content">
                @if (isActiveTab('chat')) {
                <app-chat></app-chat>
                } @else {
                <app-game-log></app-game-log>
                }
            </div>
        </aside>
    </div>
</app-ui-page-layout>
