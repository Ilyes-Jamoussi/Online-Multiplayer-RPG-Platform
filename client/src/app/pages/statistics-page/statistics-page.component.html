<app-ui-page-layout [hasHeader]="true" [showBackButton]="true" headerTitle="Statistiques de fin de partie" (backClick)="onBackClick()">
    <div class="statistics-grid">
        <!-- Zone des statistiques globales - 1/3 hauteur, toute la largeur -->
        <section class="global-statistics">
            <h2>Statistiques Globales</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Durée de la partie</span>
                    <span class="stat-value">{{ globalStatistics().gameDuration }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Nombre de tours de jeu</span>
                    <span class="stat-value">{{ globalStatistics().totalTurns }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Tuiles visitées</span>
                    <span class="stat-value">{{ globalStatistics().tilesVisitedPercentage }}%</span>
                </div>
                @if (globalStatistics().totalTeleportations !== undefined) {
                <div class="stat-item">
                    <span class="stat-label">Total téléportations</span>
                    <span class="stat-value">{{ globalStatistics().totalTeleportations }}</span>
                </div>
                } @if (globalStatistics().doorsManipulatedPercentage !== undefined) {
                <div class="stat-item">
                    <span class="stat-label">Portes manipulées</span>
                    <span class="stat-value">{{ globalStatistics().doorsManipulatedPercentage }}%</span>
                </div>
                } @if (globalStatistics().sanctuariesUsedPercentage !== undefined) {
                <div class="stat-item">
                    <span class="stat-label">Sanctuaires utilisés</span>
                    <span class="stat-value">{{ globalStatistics().sanctuariesUsedPercentage }}%</span>
                </div>
                } @if (globalStatistics().flagHoldersCount !== undefined) {
                <div class="stat-item">
                    <span class="stat-label">Joueurs ayant détenu le drapeau</span>
                    <span class="stat-value">{{ globalStatistics().flagHoldersCount }}</span>
                </div>
                }
            </div>
        </section>

        <!-- Tableau des joueurs - 2/3 hauteur, 2/3 largeur -->
        <section class="players-table-section">
            <h2>Statistiques des Joueurs</h2>
            <div class="table-container">
                <table class="players-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th
                                class="sortable"
                                (click)="sortBy('combatCount')"
                                [class.active]="isSortActive('combatCount')"
                                [attr.data-sort]="getSortIcon('combatCount')"
                            >
                                <div class="header-content">
                                    <span class="header-text">Combats</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th
                                class="sortable"
                                (click)="sortBy('combatWins')"
                                [class.active]="isSortActive('combatWins')"
                                [attr.data-sort]="getSortIcon('combatWins')"
                            >
                                <div class="header-content">
                                    <span class="header-text">Victoires</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th
                                class="sortable"
                                (click)="sortBy('combatLosses')"
                                [class.active]="isSortActive('combatLosses')"
                                [attr.data-sort]="getSortIcon('combatLosses')"
                            >
                                <div class="header-content">
                                    <span class="header-text">Défaites</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th
                                class="sortable"
                                (click)="sortBy('healthLost')"
                                [class.active]="isSortActive('healthLost')"
                                [attr.data-sort]="getSortIcon('healthLost')"
                            >
                                <div class="header-content">
                                    <span class="header-text">PV perdus</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th
                                class="sortable"
                                (click)="sortBy('healthDealt')"
                                [class.active]="isSortActive('healthDealt')"
                                [attr.data-sort]="getSortIcon('healthDealt')"
                            >
                                <div class="header-content">
                                    <span class="header-text">PV infligés</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                            <th
                                class="sortable"
                                (click)="sortBy('tilesVisitedPercentage')"
                                [class.active]="isSortActive('tilesVisitedPercentage')"
                                [attr.data-sort]="getSortIcon('tilesVisitedPercentage')"
                            >
                                <div class="header-content">
                                    <span class="header-text">Tuiles visitées (%)</span>
                                    <span class="sort-indicator"></span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (player of playersStatistics(); track player.name) {
                        <tr>
                            <td class="player-name">{{ player.name }}</td>
                            <td class="stat-number">{{ player.combatCount }}</td>
                            <td class="stat-number wins">{{ player.combatWins }}</td>
                            <td class="stat-number losses">{{ player.combatLosses }}</td>
                            <td class="stat-number">{{ player.healthLost }}</td>
                            <td class="stat-number">{{ player.healthDealt }}</td>
                            <td class="stat-number">{{ player.tilesVisitedPercentage }}%</td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Zone de clavardage/journal - 2/3 hauteur, 1/3 largeur -->
        <aside class="messages-section">
            <div class="messages-header">
                <h2>Zone des messages</h2>
                <div class="header-controls">
                    <div class="tabs">
                        <button class="tab" [class.active]="isActiveTab('chat')" (click)="setActiveTab('chat')">Chat</button>
                        <button class="tab" [class.active]="isActiveTab('journal')" (click)="setActiveTab('journal')">Journal</button>
                    </div>
                    @if (isActiveTab('journal')) {
                    <label class="filter-checkbox">
                        <input type="checkbox" [checked]="!gameLogService.filterByMe()" (change)="gameLogService.toggleFilter()" />
                        <span>Tout</span>
                    </label>
                    }
                </div>
            </div>
            <div class="messages-content">
                @if (isActiveTab('chat')) {
                <app-chat></app-chat>
                } @else {
                <app-game-log></app-game-log>
                }
            </div>
        </aside>
    </div>
</app-ui-page-layout>
