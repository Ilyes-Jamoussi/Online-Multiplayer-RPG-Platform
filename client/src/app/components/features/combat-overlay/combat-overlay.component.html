@if (combatData && combatData.userRole !== 'spectator') {
<div class="combat-overlay" [class.victory-mode]="isVictoryNotificationVisible">
    <div class="combat-container">
        @if (victoryData && isVictoryNotificationVisible) {
        <app-combat-result [victoryData]="victoryData" [isVictory]="isVictory" [victoryMessage]="victoryMessage" [victorySubtitle]="victorySubtitle"></app-combat-result>
        } @else {
        <div class="combat-header">
            <div class="combat-title">
                <span class="swords-icon">‚öîÔ∏è</span>
                <h2>Combat</h2>
                <span class="swords-icon">‚öîÔ∏è</span>
            </div>
            <app-combat-timer></app-combat-timer>
        </div>
        }

        <div class="combat-arena">
            <div class="fighter player-a" [class.is-me]="combatData.userRole === 'attacker'" [class.has-damage]="playerADamage">
                <div class="fighter-card">
                    <div class="fighter-header">
                        <div class="fighter-name">{{ playerAName }}</div>
                        <div class="fighter-badges">
                            @if (playerAPosture) {
                            <span class="posture-badge" [class.offensive]="playerAPosture === 'offensive'" [class.defensive]="playerAPosture === 'defensive'">
                                {{ playerAPosture === 'offensive' ? '‚öîÔ∏è' : 'üõ°Ô∏è' }}
                            </span>
                            }
                            @if (playerATileEffectLabel) {
                            <span class="tile-effect-badge">‚ùÑÔ∏è</span>
                            }
                        </div>
                    </div>

                    <div class="fighter-avatar-wrapper">
                        <div class="avatar-glow" [class.active]="playerADamage"></div>
                        <img [src]="playerAAvatar" [alt]="playerAName" class="fighter-avatar" />
                        @if (playerADamage && playerADamage.damage > 0) {
                        <div class="damage-splash">-{{ playerADamage.damage }}</div>
                        }
                    </div>

                    <div class="health-section">
                        <div class="health-bar">
                            <div class="health-bar-fill" [style.width.%]="playerAHealth.percentage" [class.low-health]="playerAHealth.percentage <= 25" [class.medium-health]="playerAHealth.percentage > 25 && playerAHealth.percentage <= 50"></div>
                        </div>
                        <div class="health-text">{{ playerAHealth.current }} / {{ playerAHealth.max }} HP</div>
                    </div>

                    @if (playerADamage) {
                    <div class="combat-stats">
                        <div class="stat-row attack">
                            <div class="stat-label">
                                <span class="stat-icon">‚öîÔ∏è</span>
                                <span>Attaque</span>
                            </div>
                            <div class="stat-details">
                                <img [src]="getDiceImage(playerADamage.attackDice)" class="dice-img" />
                                <span class="dice-value">{{ playerADamage.attackRoll }}</span>
                                @if (playerADamage.attackBonus > 0) {
                                <span class="bonus">+{{ playerADamage.attackBonus }}</span>
                                }
                                @if (playerADamage.attackPostureBonus > 0) {
                                <span class="bonus posture">+{{ playerADamage.attackPostureBonus }}</span>
                                }
                                <span class="total">= {{ playerADamage.totalAttack }}</span>
                            </div>
                        </div>
                        <div class="stat-row defense">
                            <div class="stat-label">
                                <span class="stat-icon">üõ°Ô∏è</span>
                                <span>D√©fense</span>
                            </div>
                            <div class="stat-details">
                                <img [src]="getDiceImage(playerADamage.defenseDice)" class="dice-img" />
                                <span class="dice-value">{{ playerADamage.defenseRoll }}</span>
                                @if (playerADamage.defenseBonus > 0) {
                                <span class="bonus">+{{ playerADamage.defenseBonus }}</span>
                                }
                                @if (playerADamage.defensePostureBonus > 0) {
                                <span class="bonus posture">+{{ playerADamage.defensePostureBonus }}</span>
                                }
                                <span class="total">= {{ playerADamage.totalDefense }}</span>
                            </div>
                        </div>
                        @if (playerADamage.tileEffect !== 0) {
                        <div class="stat-row ice">
                            <div class="stat-label">
                                <span class="stat-icon">‚ùÑÔ∏è</span>
                                <span>Glace</span>
                            </div>
                            <div class="stat-details">
                                <span class="total ice">{{ playerADamage.tileEffect }}</span>
                            </div>
                        </div>
                        }
                    </div>
                    }
                </div>
            </div>

            <div class="vs-divider">
                <div class="vs-circle">
                    <span class="vs-text">VS</span>
                </div>
                <div class="lightning-effect"></div>
            </div>

            <div class="fighter player-b" [class.is-me]="combatData.userRole === 'target'" [class.has-damage]="playerBDamage">
                <div class="fighter-card">
                    <div class="fighter-header">
                        <div class="fighter-name">{{ playerBName }}</div>
                        <div class="fighter-badges">
                            @if (playerBPosture) {
                            <span class="posture-badge" [class.offensive]="playerBPosture === 'offensive'" [class.defensive]="playerBPosture === 'defensive'">
                                {{ playerBPosture === 'offensive' ? '‚öîÔ∏è' : 'üõ°Ô∏è' }}
                            </span>
                            }
                            @if (playerBTileEffectLabel) {
                            <span class="tile-effect-badge">‚ùÑÔ∏è</span>
                            }
                        </div>
                    </div>

                    <div class="fighter-avatar-wrapper">
                        <div class="avatar-glow" [class.active]="playerBDamage"></div>
                        <img [src]="playerBAvatar" [alt]="playerBName" class="fighter-avatar" />
                        @if (playerBDamage && playerBDamage.damage > 0) {
                        <div class="damage-splash">-{{ playerBDamage.damage }}</div>
                        }
                    </div>

                    <div class="health-section">
                        <div class="health-bar">
                            <div class="health-bar-fill" [style.width.%]="playerBHealth.percentage" [class.low-health]="playerBHealth.percentage <= 25" [class.medium-health]="playerBHealth.percentage > 25 && playerBHealth.percentage <= 50"></div>
                        </div>
                        <div class="health-text">{{ playerBHealth.current }} / {{ playerBHealth.max }} HP</div>
                    </div>

                    @if (playerBDamage) {
                    <div class="combat-stats">
                        <div class="stat-row attack">
                            <div class="stat-label">
                                <span class="stat-icon">‚öîÔ∏è</span>
                                <span>Attaque</span>
                            </div>
                            <div class="stat-details">
                                <img [src]="getDiceImage(playerBDamage.attackDice)" class="dice-img" />
                                <span class="dice-value">{{ playerBDamage.attackRoll }}</span>
                                @if (playerBDamage.attackBonus > 0) {
                                <span class="bonus">+{{ playerBDamage.attackBonus }}</span>
                                }
                                @if (playerBDamage.attackPostureBonus > 0) {
                                <span class="bonus posture">+{{ playerBDamage.attackPostureBonus }}</span>
                                }
                                <span class="total">= {{ playerBDamage.totalAttack }}</span>
                            </div>
                        </div>
                        <div class="stat-row defense">
                            <div class="stat-label">
                                <span class="stat-icon">üõ°Ô∏è</span>
                                <span>D√©fense</span>
                            </div>
                            <div class="stat-details">
                                <img [src]="getDiceImage(playerBDamage.defenseDice)" class="dice-img" />
                                <span class="dice-value">{{ playerBDamage.defenseRoll }}</span>
                                @if (playerBDamage.defenseBonus > 0) {
                                <span class="bonus">+{{ playerBDamage.defenseBonus }}</span>
                                }
                                @if (playerBDamage.defensePostureBonus > 0) {
                                <span class="bonus posture">+{{ playerBDamage.defensePostureBonus }}</span>
                                }
                                <span class="total">= {{ playerBDamage.totalDefense }}</span>
                            </div>
                        </div>
                        @if (playerBDamage.tileEffect !== 0) {
                        <div class="stat-row ice">
                            <div class="stat-label">
                                <span class="stat-icon">‚ùÑÔ∏è</span>
                                <span>Glace</span>
                            </div>
                            <div class="stat-details">
                                <span class="total ice">{{ playerBDamage.tileEffect }}</span>
                            </div>
                        </div>
                        }
                    </div>
                    }
                </div>
            </div>
        </div>

        @if (!victoryData) {
        <div class="combat-actions">
            <div class="action-prompt">
                @if (isPostureSelected) {
                <span class="selected-posture">
                    {{ selectedPosture === 'offensive' ? '‚öîÔ∏è Offensive' : 'üõ°Ô∏è D√©fensive' }} s√©lectionn√©e
                </span>
                } @else {
                <span class="prompt-text">Choisissez votre posture de combat</span>
                }
            </div>

            <div class="action-buttons">
                <button class="combat-btn offensive" [class.selected]="selectedPosture === 'offensive'" [disabled]="isPostureSelected" (click)="chooseOffensive()">
                    <span class="btn-icon">‚öîÔ∏è</span>
                    <span class="btn-content">
                        <span class="btn-title">Offensive</span>
                        <span class="btn-bonus">+2 Attaque</span>
                    </span>
                </button>
                <button class="combat-btn defensive" [class.selected]="selectedPosture === 'defensive'" [disabled]="isPostureSelected" (click)="chooseDefensive()">
                    <span class="btn-icon">üõ°Ô∏è</span>
                    <span class="btn-content">
                        <span class="btn-title">D√©fensive</span>
                        <span class="btn-bonus">+2 D√©fense</span>
                    </span>
                </button>
            </div>
        </div>
        }
    </div>
</div>
}
