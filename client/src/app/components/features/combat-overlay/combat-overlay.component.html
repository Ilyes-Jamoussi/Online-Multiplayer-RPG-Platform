@if (combatData && combatData.userRole !== 'spectator') {
<div class="combat-overlay" [class.victory-mode]="isVictoryNotificationVisible">
    <div class="combat-container">
        @if (victoryData && isVictoryNotificationVisible) {
        <div class="victory-section">
            <app-combat-result
                [victoryData]="victoryData"
                [isVictory]="isVictory"
                [victoryMessage]="victoryMessage"
                [victorySubtitle]="victorySubtitle"
            ></app-combat-result>
            <button class="close-btn" (click)="closeVictoryOverlay()">‚úï</button>
        </div>
        } @else {
        <header class="combat-header">
            <app-combat-timer></app-combat-timer>
        </header>

        <main class="combat-main">
            <div class="fighter-panel player-a" [class.is-me]="combatData.userRole === 'attacker'" [class.has-damage]="playerADamage">
                <div class="fighter-identity">
                    <img [src]="playerAAvatar" [alt]="playerAName" class="fighter-avatar" />
                    @if (playerADamage && playerADamage.damage > 0) {
                    <div class="damage-splash">-{{ playerADamage.damage }}</div>
                    }
                </div>

                <div class="fighter-info">
                    <div class="fighter-name-row">
                        <span class="fighter-name">{{ playerAName }}</span>
                        <div class="badges">
                            @if (playerAPosture) {
                            <span class="posture-badge" [class.offensive]="playerAPosture === 'offensive'" [class.defensive]="playerAPosture === 'defensive'">
                                {{ playerAPosture === 'offensive' ? '‚öîÔ∏è' : 'üõ°Ô∏è' }}
                            </span>
                            }
                            @if (playerATileEffectLabel) {
                            <span class="tile-effect-badge">‚ùÑÔ∏è</span>
                            }
                        </div>
                    </div>

                    <div class="health-bar-container">
                        <div class="health-bar">
                            <div
                                class="health-fill"
                                [style.width.%]="playerAHealth.percentage"
                                [class.low]="playerAHealth.percentage <= 25"
                                [class.medium]="playerAHealth.percentage > 25 && playerAHealth.percentage <= 50"
                            ></div>
                        </div>
                        <span class="health-text">{{ playerAHealth.current }}/{{ playerAHealth.max }}</span>
                    </div>

                    <div class="combat-stats-container">
                        @if (playerADamage) {
                        <div class="combat-stats">
                            <div class="stat attack">
                                <span class="stat-icon">‚öîÔ∏è</span>
                                <span class="base-value">{{ baseStatValue }}</span>
                                <span class="plus">+</span>
                                <img [src]="getDiceImage(playerADamage.attackDice)" class="dice-img" />
                                <span class="roll">{{ playerADamage.attackRoll }}</span>
                                @if (playerADamage.attackBonus > 0) {
                                <span class="bonus">+{{ playerADamage.attackBonus }}</span>
                                }
                                @if (playerADamage.attackPostureBonus > 0) {
                                <span class="bonus posture">+{{ playerADamage.attackPostureBonus }}</span>
                                }
                                <span class="equals">=</span>
                                <span class="total">{{ playerADamage.totalAttack }}</span>
                            </div>
                            <div class="stat defense">
                                <span class="stat-icon">üõ°Ô∏è</span>
                                <span class="base-value">{{ baseStatValue }}</span>
                                <span class="plus">+</span>
                                <img [src]="getDiceImage(playerADamage.defenseDice)" class="dice-img" />
                                <span class="roll">{{ playerADamage.defenseRoll }}</span>
                                @if (playerADamage.defenseBonus > 0) {
                                <span class="bonus">+{{ playerADamage.defenseBonus }}</span>
                                }
                                @if (playerADamage.defensePostureBonus > 0) {
                                <span class="bonus posture">+{{ playerADamage.defensePostureBonus }}</span>
                                }
                                <span class="equals">=</span>
                                <span class="total">{{ playerADamage.totalDefense }}</span>
                            </div>
                            @if (playerADamage.tileEffect !== 0) {
                            <div class="stat ice">
                                <span class="stat-icon">‚ùÑÔ∏è</span>
                                <span class="total ice">{{ playerADamage.tileEffect }}</span>
                            </div>
                            }
                        </div>
                        } @else {
                        <div class="combat-stats-placeholder"></div>
                        }
                    </div>
                </div>
            </div>

            <div class="vs-separator">
                <div class="vs-badge">VS</div>
            </div>

            <div class="fighter-panel player-b" [class.is-me]="combatData.userRole === 'target'" [class.has-damage]="playerBDamage">
                <div class="fighter-identity">
                    <img [src]="playerBAvatar" [alt]="playerBName" class="fighter-avatar" />
                    @if (playerBDamage && playerBDamage.damage > 0) {
                    <div class="damage-splash">-{{ playerBDamage.damage }}</div>
                    }
                </div>

                <div class="fighter-info">
                    <div class="fighter-name-row">
                        <span class="fighter-name">{{ playerBName }}</span>
                        <div class="badges">
                            @if (playerBPosture) {
                            <span class="posture-badge" [class.offensive]="playerBPosture === 'offensive'" [class.defensive]="playerBPosture === 'defensive'">
                                {{ playerBPosture === 'offensive' ? '‚öîÔ∏è' : 'üõ°Ô∏è' }}
                            </span>
                            }
                            @if (playerBTileEffectLabel) {
                            <span class="tile-effect-badge">‚ùÑÔ∏è</span>
                            }
                        </div>
                    </div>

                    <div class="health-bar-container">
                        <div class="health-bar">
                            <div
                                class="health-fill"
                                [style.width.%]="playerBHealth.percentage"
                                [class.low]="playerBHealth.percentage <= 25"
                                [class.medium]="playerBHealth.percentage > 25 && playerBHealth.percentage <= 50"
                            ></div>
                        </div>
                        <span class="health-text">{{ playerBHealth.current }}/{{ playerBHealth.max }}</span>
                    </div>

                    <div class="combat-stats-container">
                        @if (playerBDamage) {
                        <div class="combat-stats">
                            <div class="stat attack">
                                <span class="stat-icon">‚öîÔ∏è</span>
                                <span class="base-value">{{ baseStatValue }}</span>
                                <span class="plus">+</span>
                                <img [src]="getDiceImage(playerBDamage.attackDice)" class="dice-img" />
                                <span class="roll">{{ playerBDamage.attackRoll }}</span>
                                @if (playerBDamage.attackBonus > 0) {
                                <span class="bonus">+{{ playerBDamage.attackBonus }}</span>
                                }
                                @if (playerBDamage.attackPostureBonus > 0) {
                                <span class="bonus posture">+{{ playerBDamage.attackPostureBonus }}</span>
                                }
                                <span class="equals">=</span>
                                <span class="total">{{ playerBDamage.totalAttack }}</span>
                            </div>
                            <div class="stat defense">
                                <span class="stat-icon">üõ°Ô∏è</span>
                                <span class="base-value">{{ baseStatValue }}</span>
                                <span class="plus">+</span>
                                <img [src]="getDiceImage(playerBDamage.defenseDice)" class="dice-img" />
                                <span class="roll">{{ playerBDamage.defenseRoll }}</span>
                                @if (playerBDamage.defenseBonus > 0) {
                                <span class="bonus">+{{ playerBDamage.defenseBonus }}</span>
                                }
                                @if (playerBDamage.defensePostureBonus > 0) {
                                <span class="bonus posture">+{{ playerBDamage.defensePostureBonus }}</span>
                                }
                                <span class="equals">=</span>
                                <span class="total">{{ playerBDamage.totalDefense }}</span>
                            </div>
                            @if (playerBDamage.tileEffect !== 0) {
                            <div class="stat ice">
                                <span class="stat-icon">‚ùÑÔ∏è</span>
                                <span class="total ice">{{ playerBDamage.tileEffect }}</span>
                            </div>
                            }
                        </div>
                        } @else {
                        <div class="combat-stats-placeholder"></div>
                        }
                    </div>
                </div>
            </div>
        </main>

        <footer class="combat-footer">
            @if (isPostureSelected) {
            <div class="posture-selected">
                <span class="selected-icon">{{ selectedPosture === 'offensive' ? '‚öîÔ∏è' : 'üõ°Ô∏è' }}</span>
                <span class="selected-text">{{ selectedPosture === 'offensive' ? 'Offensive' : 'D√©fensive' }} s√©lectionn√©e</span>
            </div>
            } @else {
            <div class="posture-prompt">Choisissez une posture</div>
            <div class="posture-buttons">
                <button class="posture-btn offensive" [class.selected]="selectedPosture === 'offensive'" [disabled]="isPostureSelected" (click)="chooseOffensive()">
                    <span class="btn-icon">‚öîÔ∏è</span>
                    <span class="btn-label">Offensive</span>
                    <span class="btn-bonus">+2 ATK</span>
                </button>
                <button class="posture-btn defensive" [class.selected]="selectedPosture === 'defensive'" [disabled]="isPostureSelected" (click)="chooseDefensive()">
                    <span class="btn-icon">üõ°Ô∏è</span>
                    <span class="btn-label">D√©fensive</span>
                    <span class="btn-bonus">+2 DEF</span>
                </button>
            </div>
            }
        </footer>
        }
    </div>

    <button class="abandon-btn" (click)="onLeaveGame()" title="Abandonner le combat">
        <span class="abandon-icon">üö™</span>
        <span class="abandon-text">Abandonner</span>
    </button>
</div>
}
